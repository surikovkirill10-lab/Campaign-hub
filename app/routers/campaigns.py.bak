from fastapi import APIRouter, Request, Form
from fastapi.responses import HTMLResponse, RedirectResponse, Response
from fastapi.templating import Jinja2Templates
from pathlib import Path
import pandas as pd
import sqlite3
import os
import math
from datetime import date
import requests
import xml.etree.ElementTree as ET
from app.services.config_store import get_effective_system_config
from app.services.cats_export import _ensure_session  # авторизованная requests.Session  :contentReference[oaicite:4]{index=4}


router = APIRouter()
templates = Jinja2Templates(directory="app/templates")

# ------------------ утилиты ------------------

def _to_float(x):
    if x is None:
        return None
    if isinstance(x, (int, float)):
        return float(x)
    if isinstance(x, str):
        s = x.replace("\xa0","").replace(" ", "").replace(",", ".").strip()
        if s == "":
            return None
        try:
            return float(s)
        except ValueError:
            return None
    try:
        return float(x)
    except Exception:
        return None

def safe_ratio(numer, denom, ndigits=2):
    n = _to_float(numer)
    d = _to_float(denom)
    if n is None or d is None:
        return None
    if not math.isfinite(n) or not math.isfinite(d):
        return None
    if d <= 0.0:
        return None
    try:
        val = n / d
    except Exception:
        return None
    if not math.isfinite(val):
        return None
    return round(val, ndigits)

def _campaign_totals(cid: int):
    p = Path("data") / "cats" / str(cid) / "latest_normalized.csv"
    if not p.exists():
        return None
    try:
        df = pd.read_csv(p)
    except Exception:
        return None
    if df is None or getattr(df, 'empty', False):
        return None

    total_idx = None
    for col in ("date", "День"):
        if col in df.columns:
            mask = df[col].isna() | df[col].astype(str).str.strip().str.lower().isin(["nan","none","nat","total",""])
            idx = list(df[mask].index)
            if idx:
                total_idx = idx[-1]
                break
    try:
        row = df.iloc[-1] if total_idx is None else df.loc[total_idx]
    except Exception:
        return None

    def to_num(x):
        try:
            return float(str(x).replace(" ","").replace(",",".")) if pd.notna(x) else None
        except Exception:
            return None

    impressions = to_num(row.get("impressions", row.get("Показы")))
    clicks      = to_num(row.get("clicks", row.get("Переходы")))
    uniques     = to_num(row.get("uniques", row.get("Охват")))
    ctr_raw     = to_num(row.get("ctr_percent", row.get("CTR")))
    freq_val    = to_num(row.get("freq"))
    ctr_ratio   = (ctr_raw/100.0) if ctr_raw is not None else None
    if freq_val is None:
        freq_val = safe_ratio(impressions, uniques, ndigits=2)
    return {
        "impressions": int(impressions) if impressions else None,
        "clicks":      int(clicks)      if clicks else None,
        "uniques":     int(uniques)     if uniques else None,
        "ctr_ratio":   ctr_ratio,
        "freq":        freq_val,
    }

def _fetch_all_campaigns_from_db():
    dbp = os.path.join(os.getcwd(), "campaign_hub.db")
    con = sqlite3.connect(dbp)
    cur = con.cursor()
    cur.execute("CREATE TABLE IF NOT EXISTS campaigns (id INTEGER PRIMARY KEY, name TEXT)")
    rows = cur.execute("SELECT id, COALESCE(name,'') FROM campaigns").fetchall()
    con.close()

    class C: pass
    cs = []
    for cid, cname in rows:
        o = C()
        o.id = cid
        o.name = cname
        o.min_date = None
        o.max_date = None
        o.impressions = None
        o.clicks = None
        o.uniques = None
        o.ctr_ext = None
        o.freq = None
        o.spend = None
        o.conversions = None
        cs.append(o)
    return cs

def _ensure_list():
    """Пробуем взять из app.services.crud, иначе читаем SQLite напрямую."""
    campaigns = []
    try:
        from app.services import crud
        if hasattr(crud, "list"):
            campaigns = crud.list()
        elif hasattr(crud, "list_campaigns"):
            campaigns = crud.list_campaigns()
    except Exception:
        pass
    if campaigns:
        return campaigns
    return _fetch_all_campaigns_from_db()

def _update_name(cid: int, name: str):
    """Правка названия кампании в CRUD или SQLite."""
    try:
        from app.services import crud
        if hasattr(crud, "update"):
            crud.update(id=cid, name=name)
            return
        if hasattr(crud, "update_campaign"):
            crud.update_campaign(id=cid, name=name)
            return
    except Exception:
        pass
    dbp = os.path.join(os.getcwd(), "campaign_hub.db")
    con = sqlite3.connect(dbp)
    cur = con.cursor()
    cur.execute("UPDATE campaigns SET name=? WHERE id=?", (name, cid))
    con.commit(); con.close()

def _delete_campaign(cid: int):
    """Удаление кампании из CRUD или SQLite."""
    try:
        from app.services import crud
        if hasattr(crud, "delete"):
            crud.delete(id=cid); return
        if hasattr(crud, "delete_campaign"):
            crud.delete_campaign(id=cid); return
    except Exception:
        pass
    dbp = os.path.join(os.getcwd(), "campaign_hub.db")
    con = sqlite3.connect(dbp)
    cur = con.cursor()
    cur.execute("DELETE FROM campaigns WHERE id=?", (cid,))
    con.commit(); con.close()

def _find_campaign(cid: int):
    for c in _ensure_list():
        if int(getattr(c, "id")) == int(cid):
            return c
    return None

def _apply_totals(c):
    totals = _campaign_totals(c.id)
    if totals:
        if totals["impressions"] is not None: c.impressions = totals["impressions"]
        if totals["clicks"]      is not None: c.clicks      = totals["clicks"]
        if totals["uniques"]     is not None: c.uniques     = totals["uniques"]
        c.ctr_ext = totals["ctr_ratio"] if totals.get("ctr_ratio") is not None else getattr(c, "ctr_ext", None)
        c.freq    = totals["freq"]      if totals.get("freq")      is not None else getattr(c, "freq", None)
    return c

def _render_row_html(c):
    """Возвращает HTML одной обычной строки таблицы + соседний details контейнер."""
    ctr_txt = ("{:.2f}%".format(c.ctr_ext*100)) if (getattr(c, "ctr_ext", None) is not None) else "–"
    freq_txt = ("{:.2f}".format(c.freq)) if (getattr(c, "freq", None) is not None) else "–"
    period = f"{c.min_date} — {c.max_date}" if (getattr(c, "min_date", None) and getattr(c, "max_date", None)) else "—"
    spend = getattr(c, "spend", None) or "–"
    conv  = getattr(c, "conversions", None) or "–"
    imp   = getattr(c, "impressions", None) or "–"
    clk   = getattr(c, "clicks", None) or "–"
    uni   = getattr(c, "uniques", None) or "–"

    return HTMLResponse(
        "".join([
            f"<tr id='row-{c.id}'>",
            f"<td>{c.id}</td>",
            f"<td>{c.name}</td>",
            f"<td>{period}</td>",
            f"<td><span id='imp-{c.id}'>{imp}</span></td>",
            f"<td><span id='clk-{c.id}'>{clk}</span></td>",
            f"<td>{spend}</td>",
            f"<td><span id='uniq-{c.id}'>{uni}</span></td>",
            f"<td>{conv}</td>",
            f"<td><span id='ctr-{c.id}'>{ctr_txt}</span></td>",
            f"<td><span id='freq-{c.id}'>{freq_txt}</span></td>",
            "<td class='is-narrow'>",
            f"<button type='button' class='button is-info is-small' "
            f"hx-post='/campaigns/{c.id}/pull' hx-target='#camp-{c.id}-status' hx-swap='innerHTML'>Update</button>",
            f"<span id='camp-{c.id}-status' class='tag is-light'>—</span>",
            f"<button type='button' class='button is-warning is-small' "
            f"hx-post='/campaigns/{c.id}/yandex_update' hx-target='#camp-{c.id}-status' hx-swap='innerHTML'>Yandex</button>",
            f"<button type='button' class='button is-small is-light' "
            f"hx-get='/campaigns/{c.id}/daily5' hx-target='#details-{c.id}' hx-swap='outerHTML'><span hx-indicator='#details-{c.id}'>Details</span></button>",
            f"<button type='button' class='button is-small is-light is-danger is-outlined' "
            f"hx-get='/campaigns/{c.id}/daily_empty' hx-target='#details-{c.id}' hx-swap='outerHTML'>Hide</button>",
            f"<button type='button' class='button is-small is-primary is-light' "
            f"hx-get='/campaigns/{c.id}/edit' hx-target='#row-{c.id}' hx-swap='outerHTML'>Edit</button>",
            f"<button type='button' class='button is-small is-danger is-light' "
            f"hx-post='/campaigns/{c.id}/delete' hx-target='#row-{c.id}' hx-swap='outerHTML'>Delete</button>",
            "</td></tr>",
            f"<tr><td colspan='11' id='details-{c.id}'></td></tr>",
        ])
    )


def _render_edit_row_html(c):
    """HTML строки в режиме редактирования (правим ТОЛЬКО name)."""
    from html import escape as _esc

    period  = f"{c.min_date} — {c.max_date}" if (getattr(c, "min_date", None) and getattr(c, "max_date", None)) else "—"
    imp     = getattr(c, "impressions", None) or "–"
    clk     = getattr(c, "clicks", None) or "–"
    uni     = getattr(c, "uniques", None) or "–"
    ctr_txt = ("{:.2f}%".format(c.ctr_ext*100)) if (getattr(c, "ctr_ext", None) is not None) else "–"
    freq_txt= ("{:.2f}".format(c.freq)) if (getattr(c, "freq", None) is not None) else "–"
    spend   = getattr(c, "spend", None) or "–"
    conv    = getattr(c, "conversions", None) or "–"

    safe_name = _esc((getattr(c, "name", "") or ""), quote=True).replace("'", "&#39;")

    return HTMLResponse(
        "".join([
            f"<tr id='row-{c.id}'>",
            f"<td>{c.id}</td>",
            "<td>",
            f"<form hx-post='/campaigns/{c.id}/update' hx-target='#row-{c.id}' hx-swap='outerHTML' class='is-inline'>",
            f"<input class='input is-small' type='text' name='name' value='{safe_name}' style='max-width:22rem' />",
            "</form>",
            "</td>",
            f"<td>{period}</td>",
            f"<td><span id='imp-{c.id}'>{imp}</span></td>",
            f"<td><span id='clk-{c.id}'>{clk}</span></td>",
            f"<td>{spend}</td>",
            f"<td><span id='uniq-{c.id}'>{uni}</span></td>",
            f"<td>{conv}</td>",
            f"<td><span id='ctr-{c.id}'>{ctr_txt}</span></td>",
            f"<td><span id='freq-{c.id}'>{freq_txt}</span></td>",
            "<td class='is-narrow'>",
            f"<button type='submit' formmethod='post' formaction='/campaigns/{c.id}/update' "
            f"class='button is-success is-small' hx-post='/campaigns/{c.id}/update' hx-target='#row-{c.id}' hx-swap='outerHTML'>Save</button>",
            f"<button type='button' class='button is-light is-small' "
            f"hx-get='/campaigns/{c.id}/row' hx-target='#row-{c.id}' hx-swap='outerHTML'>Cancel</button>",
            "</td></tr>",
            f"<tr><td colspan='11' id='details-{c.id}'></td></tr>",
        ])
    )
    _apply_totals(c)
    return _render_row_html(c)

@router.get("/campaigns/{cid}/edit", response_class=HTMLResponse)
def campaigns_edit(cid: int):
    c = _find_campaign(cid)
    if not c:
        return HTMLResponse("", status_code=404)
    _apply_totals(c)
    return _render_edit_row_html(c)

@router.post("/campaigns/{cid}/update", response_class=HTMLResponse)
def campaigns_update(cid: int, name: str = Form(...)):
    # По соображениям целостности НЕ меняем ID, правим только name
    _update_name(cid, name.strip())
    c = _find_campaign(cid)
    if not c:
        return HTMLResponse("", status_code=404)
    c.name = name.strip()
    _apply_totals(c)
    return _render_row_html(c)

@router.post("/campaigns/{cid}/delete", response_class=HTMLResponse)
def campaigns_delete(cid: int):
    _delete_campaign(cid)
    # Возвращаем пустую замену, чтобы hx-swap="outerHTML" стёр строку
    return HTMLResponse("")

# ------- уже существующие твои обработчики ниже как были -------

@router.post("/campaigns/{cid}/pull", response_class=HTMLResponse)
def campaigns_pull(cid: int):
    try:
        from app.services.cats_export import export_and_ingest
        res = export_and_ingest(str(cid))
        totals = _campaign_totals(cid) or {}
        rows = res.get("ingest", {}).get("rows", "-")
        badge = f'<span class="tag is-success">OK · {rows} rows</span> '
        def span(k, v): return f'<span id="{k}-{cid}" hx-swap-oob="true">{v}</span>'
        imp  = totals.get("impressions", "–")
        clk  = totals.get("clicks", "–")
        uni  = totals.get("uniques", "–")
        ctr  = "{:.2%}".format(totals["ctr_ratio"]) if totals.get("ctr_ratio") is not None else "–"
        fr   = "{:.2f}".format(totals["freq"]) if totals.get("freq") is not None else "–"
        oob = "".join([span("imp", imp), span("clk", clk), span("uniq", uni), span("ctr", ctr), span("freq", fr)])
        return HTMLResponse(badge + oob)
    except Exception as e:
        return HTMLResponse(f'<span class="tag is-danger">FAIL</span> <small>{e}</small>', status_code=500)

@router.get("/campaigns/{cid}/daily2", response_class=HTMLResponse)
def campaigns_daily2(cid: int):
    p = Path("data") / "cats" / str(cid) / "latest_normalized.csv"
    if not p.exists():
        return HTMLResponse(f'<td colspan="11" id="details-{cid}"><p>No data (daily2)</p></td>')
    df = pd.read_csv(p)
    date_col = df["date"] if "date" in df.columns else df.get("День")
    imp  = df["impressions"] if "impressions" in df.columns else df.get("Показы")
    clk  = df["clicks"]      if "clicks"      in df.columns else df.get("Переходы")
    uni  = df["uniques"]     if "uniques"     in df.columns else df.get("Охват")
    ctrp = df["ctr_percent"] if "ctr_percent" in df.columns else df.get("CTR")
    vtrp = df["vtr_percent"] if "vtr_percent" in df.columns else df.get("VTR")
    freq = df["freq"]        if "freq"        in df.columns else None
    def num(x):
        try:
            return float(str(x).replace(" ","").replace(",","."))
        except Exception:
            return None
    if freq is None and imp is not None and uni is not None:
        impn = imp.apply(num); unin = uni.apply(num)
        freq = [round((i/u),2) if (i is not None and u and u>0) else None for i,u in zip(impn,unin)]
    def fmt_pct(v): 
        if v is None: return "—"
        try:
            return f"{float(v):.2f}%"
        except Exception:
            return "—"
    def as_int(x): 
        try:
            return int(x) if pd.notna(x) else "—"
        except Exception:
            return "—"
    rows = []
    for i in range(len(df.index)):
        raw = date_col.iloc[i] if date_col is not None else None
        d   = "Total" if (raw is None or str(raw).strip().lower() in ("nan","nat")) else raw
        im  = imp.iloc[i]  if imp  is not None else None
        ck  = clk.iloc[i]  if clk  is not None else None
        un  = uni.iloc[i]  if uni  is not None else None
        cp  = ctrp.iloc[i] if ctrp is not None else None
        vp  = vtrp.iloc[i] if vtrp is not None else None
        fq  = (freq[i] if isinstance(freq,list) and i < len(freq) else (freq.iloc[i] if hasattr(freq,'iloc') and i<len(freq) else None))
        rows.append(f"<tr><td>{d}</td><td>{as_int(im)}</td><td>{as_int(ck)}</td><td>{fmt_pct(cp)}</td><td>{fmt_pct(vp)}</td><td>{as_int(un)}</td><td>{fq if fq is not None else '—'}</td></tr>")
    inner = "<table class='table is-narrow is-striped is-fullwidth'><thead><tr><th>Дата</th><th>Показы</th><th>Клики</th><th>CTR</th><th>VTR</th><th>Охват</th><th>Частота</th></tr></thead><tbody>"+ "".join(rows) +"</tbody></table>"
    return HTMLResponse(f"<td colspan='11' id='details-{cid}' class='p-0'>{inner}</td>")

@router.get("/campaigns/{cid}/daily_empty", response_class=HTMLResponse)
def campaigns_daily_empty(cid: int):
    return HTMLResponse(f"<td colspan='11' id='details-{cid}'></td>")

@router.get("/campaigns/{cid}/daily3", response_class=HTMLResponse)
def campaigns_daily3(cid: int):
    # ... (твой неизменённый код daily3)
    from pathlib import Path
    import os, sqlite3
    import pandas as pd
    def fmt_time_sec(seconds):
        try:
            s = int(round(float(seconds))); h, rem = divmod(s, 3600); m, s2 = divmod(rem, 60)
            return f"{h:02d}:{m:02d}:{s2:02d}"
        except Exception:
            return "—"
    def fmt_float2(v):
        try: return f"{float(v):.2f}"
        except Exception: return "—"
    def fmt_pct2(v):
        try: return f"{float(v):.2f}%"
        except Exception: return "—"
    def norm_date_for_yandex(x):
        s = str(x).strip()
        if len(s) >= 10 and s[4]=='-' and s[7]=='-':  # YYYY-MM-DD
            return s[:10]
        if len(s) >= 10 and s[2]=='.' and s[5]=='.':  # DD.MM.YYYY
            d,m,y = s[:10].split('.'); return f"{y}-{m}-{d}"
        return None
    def reachability(vis, clk):
        try:
            vis = float(vis) if vis is not None else 0.0
            clk = float(clk) if clk is not None else 0.0
            return f"{(vis/clk):.2f}" if clk > 0 else "—"
        except Exception:
            return "—"
    def as_int(x):
        try: return int(float(x)) if pd.notna(x) else "—"
        except Exception: return "—"
    def num(x):
        try: return float(str(x).replace(" ","").replace(",",".")) if pd.notna(x) else None
        except Exception: return None
    p = Path("data") / "cats" / str(cid) / "latest_normalized.csv"
    if not p.exists():
        return HTMLResponse(f'<td colspan="11" id="details-{cid}"><p>No data (daily3)</p></td>')
    df = pd.read_csv(p)
    date_col = df["date"]         if "date"         in df.columns else df.get("День")
    imp      = df["impressions"]  if "impressions"  in df.columns else df.get("Показы")
    clk      = df["clicks"]       if "clicks"       in df.columns else df.get("Переходы")
    uni      = df["uniques"]      if "uniques"      in df.columns else df.get("Охват")
    ctrp     = df["ctr_percent"]  if "ctr_percent"  in df.columns else df.get("CTR")
    vtrp     = df["vtr_percent"]  if "vtr_percent"  in df.columns else df.get("VTR")
    freq     = df["freq"]         if "freq"         in df.columns else None
    if freq is None and imp is not None and uni is not None:
        impn = imp.apply(num); unin = uni.apply(num)
        freq = [round((i/u),2) if (i is not None and u and u>0) else None for i,u in zip(impn,unin)]
    ymap = {}
    try:
        ydbp = os.path.join(os.getcwd(), "yandex_metrics.db")
        con = sqlite3.connect(ydbp); cur = con.cursor()
        for rd, vis, br, pdpth, ats in cur.execute("""
            SELECT report_date, visits, bounce_rate, page_depth, avg_time_sec
              FROM yandex_daily_metrics
             WHERE campaign_id=?
        """, (cid,)):
            ymap[str(rd)] = (vis, br, pdpth, ats)
        con.close()
    except Exception:
        ymap = {}
    head = (
      "<thead><tr>"
      "<th>Дата</th><th>Показы</th><th>Клики</th><th>CTR</th><th>VTR</th><th>Охват</th><th>Частота</th>"
      "<th>Визиты</th><th>Доходимость</th><th>Отказы</th><th>Глубина</th><th>Время</th>"
      "</tr></thead>"
    )
    rows_html = []
    n = len(df.index)
    for i in range(n):
        raw = date_col.iloc[i] if date_col is not None else None
        is_total = (raw is None or str(raw).strip().lower() in ("nan","nat","total","итого"))
        d = "Total" if is_total else raw
        im  = imp.iloc[i]  if imp  is not None else None
        ck  = clk.iloc[i]  if clk  is not None else None
        un  = uni.iloc[i]  if uni  is not None else None
        cp  = ctrp.iloc[i] if ctrp is not None else None
        vp  = vtrp.iloc[i] if vtrp is not None else None
        fq  = (freq[i] if isinstance(freq,list) and i < len(freq) else (freq.iloc[i] if hasattr(freq,'iloc') and i<len(freq) else None))
        vis = br = pdpth = ats = None
        rch = "—"
        if not is_total:
            key = norm_date_for_yandex(raw)
            if key and key in ymap:
                vis, br, pdpth, ats = ymap[key]
                rch = reachability(vis, ck)
        rows_html.append(
            "<tr>"
            f"<td>{d}</td>"
            f"<td>{as_int(im)}</td>"
            f"<td>{as_int(ck)}</td>"
            f"<td>{fmt_pct2(cp)}</td>"
            f"<td>{fmt_pct2(vp)}</td>"
            f"<td>{as_int(un)}</td>"
            f"<td>{fq if fq is not None else '—'}</td>"
            f"<td>{as_int(vis) if vis is not None else '—'}</td>"
            f"<td>{rch}</td>"
            f"<td>{fmt_pct2(br) if br is not None else '—'}</td>"
            f"<td>{fmt_float2(pdpth) if pdpth is not None else '—'}</td>"
            f"<td>{fmt_time_sec(ats) if ats is not None else '—'}</td>"
            "</tr>"
        )
    inner = "<table class='table is-narrow is-striped is-fullwidth'>" + head + "<tbody>" + "".join(rows_html) + "</tbody></table>"
    return HTMLResponse(f"<td colspan='11' id='details-{cid}' class='p-0'>{inner}</td>")

@router.get("/campaigns/{cid}/daily5", response_class=HTMLResponse)
def campaigns_daily5(cid: int):
    # ... (твой неизменённый код daily5)
    from pathlib import Path
    import os, sqlite3
    import pandas as pd
    def fmt_time_sec(seconds):
        try:
            s = int(round(float(seconds)))
            h, rem = divmod(s, 3600); m, s2 = divmod(rem, 60)
            return f"{h:02d}:{m:02d}:{s2:02d}"
        except Exception:
            return "—"
    def fmt_float2(v):
        try:
            return f"{float(v):.2f}"
        except Exception:
            return "—"
    def pct0x100(v):
        try:
            return f"{int(round(float(v)*100))}%"
        except Exception:
            return "—"
    def norm_date_for_yandex(x):
        s = str(x).strip()
        if len(s) >= 10 and s[4] == '-' and s[7] == '-':
            return s[:10]
        if len(s) >= 10 and s[2] == '.' and s[5] == '.':
            d, m, y = s[:10].split('.'); return f"{y}-{m}-{d}"
        return None
    def reachability_percent(vis, clk):
        try:
            vis = float(vis) if vis is not None else 0.0
            clk = float(clk) if clk is not None else 0.0
            return f"{int(round((vis/clk)*100))}%"
        except Exception:
            return "—"
    def as_int(x):
        try:
            return int(float(x)) if pd.notna(x) else "—"
        except Exception:
            return "—"
    def num(x):
        try:
            return float(str(x).replace(" ", "").replace(",", ".")) if pd.notna(x) else None
        except Exception:
            return None
    p = Path("data") / "cats" / str(cid) / "latest_normalized.csv"
    if not p.exists():
        return HTMLResponse(f'<td colspan="11" id="details-{cid}"><p>No data (daily5)</p></td>')
    df = pd.read_csv(p)
    date_col = df["date"]         if "date"         in df.columns else df.get("День")
    imp      = df["impressions"]  if "impressions"  in df.columns else df.get("Показы")
    clk      = df["clicks"]       if "clicks"       in df.columns else df.get("Переходы")
    uni      = df["uniques"]      if "uniques"      in df.columns else df.get("Охват")
    ctrp     = df["ctr_percent"]  if "ctr_percent"  in df.columns else df.get("CTR")
    vtrp     = df["vtr_percent"]  if "vtr_percent"  in df.columns else df.get("VTR")
    freq     = df["freq"]         if "freq"         in df.columns else None
    if freq is None and imp is not None and uni is not None:
        impn = imp.apply(num); unin = uni.apply(num)
        freq = [round((i/u),2) if (i is not None and u and u>0) else None for i,u in zip(impn,unin)]
    ymap = {}
    try:
        ydbp = os.path.join(os.getcwd(), "yandex_metrics.db")
        con = sqlite3.connect(ydbp); cur = con.cursor()
        for rd, vis, br, pdpth, ats in cur.execute("""
            SELECT report_date, visits, bounce_rate, page_depth, avg_time_sec
              FROM yandex_daily_metrics
             WHERE campaign_id=?
        """, (cid,)):
            ymap[str(rd)] = (vis, br, pdpth, ats)
        con.close()
    except Exception:
        ymap = {}
    head = (
      "<thead><tr>"
      "<th>Дата</th><th>Показы</th><th>Клики</th><th>CTR</th><th>VTR</th><th>Охват</th><th>Частота</th>"
      "<th>Визиты</th><th>Доходимость</th><th>Отказы</th><th>Глубина</th><th>Время</th>"
      "</tr></thead>"
    )
    rows_html = []
    n = len(df.index)
    for i in range(n):
        raw = date_col.iloc[i] if date_col is not None else None
        is_total = (raw is None or str(raw).strip().lower() in ("nan","nat","total","итого"))
        d = "Total" if is_total else raw
        im  = imp.iloc[i]  if imp  is not None else None
        ck  = clk.iloc[i]  if clk  is not None else None
        un  = uni.iloc[i]  if uni  is not None else None
        cp  = ctrp.iloc[i] if ctrp is not None else None
        vp  = vtrp.iloc[i] if vtrp is not None else None
        fq  = (freq[i] if isinstance(freq,list) and i < len(freq) else (freq.iloc[i] if hasattr(freq,'iloc') and i<len(freq) else None))
        vis = br = pdpth = ats = None
        rch = "—"
        if not is_total:
            key = norm_date_for_yandex(raw)
            if key and key in ymap:
                vis, br, pdpth, ats = ymap[key]
                rch = reachability_percent(vis, ck)
        rows_html.append(
            "<tr>"
            f"<td>{d}</td>"
            f"<td>{as_int(im)}</td>"
            f"<td>{as_int(ck)}</td>"
            f"<td>{fmt_float2(cp)}%</td>"
            f"<td>{fmt_float2(vp)}%</td>"
            f"<td>{as_int(un)}</td>"
            f"<td>{fq if fq is not None else '—'}</td>"
            f"<td>{as_int(vis) if vis is not None else '—'}</td>"
            f"<td>{rch}</td>"
            f"<td>{pct0x100(br) if br is not None else '—'}</td>"
            f"<td>{fmt_float2(pdpth) if pdpth is not None else '—'}</td>"
            f"<td>{fmt_time_sec(ats) if ats is not None else '—'}</td>"
            "</tr>"
        )
    inner = "<table class='table is-narrow is-striped is-fullwidth'>" + head + "<tbody>" + "".join(rows_html) + "</tbody></table>"
    return HTMLResponse(f"<td colspan='11' id='details-{cid}' class='p-0'>{inner}</td>")

@router.post("/campaigns/{cid}/yandex_update", response_class=HTMLResponse)
def campaigns_yandex_update(cid: int):
    from pathlib import Path as _Path
    try:
        base_dir = _Path(__file__).resolve().parents[2]
        script_path = base_dir / "scripts" / "yandex_import.py"
        import sys as _sys, subprocess as _sub
        r = _sub.run([_sys.executable, "-u", str(script_path)], capture_output=True, text=True, timeout=600)
        if r.returncode == 0:
            return HTMLResponse('<span class="tag is-success">Yandex imported</span>')
        err = (r.stderr or r.stdout) or ""
        err = err[-4000:].replace("<","&lt;").replace(">","&gt;")
        return HTMLResponse(f'<span class="tag is-danger">Yandex import failed</span><pre>{err}</pre>', status_code=500)
    except Exception as e:
        return HTMLResponse(f'<span class="tag is-danger">Yandex error</span> <small>{e}</small>', status_code=500)



@router.get("/campaigns", response_class=HTMLResponse)
def campaigns_list_view(request: Request):
    # query params
    q = request.query_params.get("q", "") or ""
    sort = request.query_params.get("sort", "id")
    direction = request.query_params.get("dir", "desc")
    direction = direction if direction in ("asc", "desc") else "desc"

    campaigns = _ensure_list()

    # подтянем метрики перед сортировкой
    for c in campaigns:
        _apply_totals(c)

    # фильтр
    q_norm = q.strip().lower()
    if q_norm:
        def _match(c):
            name = (getattr(c, "name", "") or "").lower()
            if q_norm in name:
                return True
            try:
                return str(int(c.id)) == q_norm
            except Exception:
                return False
        campaigns = [c for c in campaigns if _match(c)]

    # сортировка
    keymap = {
        "id":          lambda c: int(getattr(c, "id", 0)),
        "name":        lambda c: (getattr(c, "name", "") or "").lower(),
        "impressions": lambda c: getattr(c, "impressions", -1) or -1,
        "clicks":      lambda c: getattr(c, "clicks", -1) or -1,
        "uniques":     lambda c: getattr(c, "uniques", -1) or -1,
        "ctr_ext":     lambda c: getattr(c, "ctr_ext", -1.0) if getattr(c, "ctr_ext", None) is not None else -1.0,
        "freq":        lambda c: getattr(c, "freq", -1.0) if getattr(c, "freq", None) is not None else -1.0,
    }
    keyfunc = keymap.get(sort, keymap["id"])
    rev = (direction == "desc")
    campaigns = sorted(campaigns, key=keyfunc, reverse=rev)

    return templates.TemplateResponse("campaigns.html", {
        "request": request, "campaigns": campaigns, "q": q, "sort": sort, "dir": direction
    })


@router.post("/campaigns", response_class=HTMLResponse)
def campaigns_add(id: int = Form(...), name: str = Form(...)):
    try:
        from app.services import crud
        if hasattr(crud, "add"):
            crud.add(id=id, name=name)
        elif hasattr(crud, "add_campaign"):
            crud.add_campaign(id=id, name=name)
        else:
            raise RuntimeError("crud.add not found")
    except Exception:
        # fallback в локальную SQLite
        import sqlite3, os
        dbp = os.path.join(os.getcwd(), "campaign_hub.db")
        con = sqlite3.connect(dbp)
        cur = con.cursor()
        cur.execute("CREATE TABLE IF NOT EXISTS campaigns (id INTEGER PRIMARY KEY, name TEXT)")
        cur.execute("INSERT OR IGNORE INTO campaigns (id, name) VALUES (?,?)", (id, name))
        con.commit(); con.close()
    return RedirectResponse(url="/campaigns", status_code=303)


@router.get("/campaigns/", response_class=HTMLResponse)
def campaigns_list_view_slash(request: Request):
    return campaigns_list_view(request)

def _parse_spreadsheetml_campaigns(xml_bytes: bytes):
    """
    Возвращает список (cid:int, name:str) из таблицы 'Кампании' (SpreadsheetML XML).
    Ищет заголовки 'ID' и 'Название', есть fallback на индексы (1,2).
    """
    ns = {"ss": "urn:schemas-microsoft-com:office:spreadsheet"}
    root = ET.fromstring(xml_bytes)
    ws = root.find(".//ss:Worksheet", ns)
    if ws is None:
        return []
    table = ws.find("ss:Table", ns)
    if table is None:
        return []
    rows = table.findall("ss:Row", ns)
    if not rows:
        return []

    # заголовок
    header = []
    for cell in rows[0].findall("ss:Cell", ns):
        d = cell.find("ss:Data", ns)
        header.append(d.text if d is not None else None)

    try:
        id_idx = header.index("ID")
        name_idx = header.index("Название")
    except Exception:
        id_idx, name_idx = 1, 2  # fallback как в твоём примере

    out = []
    for r in rows[1:]:
        vals = []
        for cell in r.findAll("ss:Cell", ns) if hasattr(r, "findAll") else r.findall("ss:Cell", ns):
            d = cell.find("ss:Data", ns)
            vals.append(d.text if d is not None else None)
        need = max(id_idx, name_idx) + 1
        if len(vals) < need:
            vals += [None]*(need - len(vals))
        cid_raw = vals[id_idx]
        name = vals[name_idx]
        n = (name or "").strip().lower()
        if "foxible" in n or "test" in n or "тест" in n:
            continue

        try:
            cid = int(str(cid_raw).strip()) if cid_raw not in (None, "", "None") else None
        except Exception:
            cid = None
        if cid:
            out.append((cid, name))
    return out


@router.post("/campaigns/import_cats", response_class=HTMLResponse)
def campaigns_import_cats():
    """
    Массовый импорт списка РК из Cats (SpreadsheetML XML).
    Авторизация — через _ensure_session(); добавляем только новые ID.
    Возвращаем <tr> (ошибки и статус) либо набор новых строк таблицы.
    """
    import traceback
    import xml.etree.ElementTree as ET

    def msg_row(text, cls="is-warning"):
        return HTMLResponse(f"<tr><td colspan='11'><span class='tag {cls}'>{text}</span></td></tr>")

    # 1) Конфиг system (ВАЖНО: тут уже секция system!)
    syscfg = get_effective_system_config("config.yaml") or {}
    base = (syscfg.get("connect_url") or syscfg.get("base_url") or "").rstrip("/")
    if not base:
        return msg_row("No connect_url/base_url in system section", "is-danger")

    # 2) Авторизованная сессия Cats
    try:
        s = _ensure_session()
    except Exception as e:
        return msg_row(f"Cats auth failed: {e}", "is-danger")

    # 3) Первый день текущего месяца
    date_str = date.today().replace(day=1).strftime("%d.%m.%Y")

    # 4) Экспорт «все кампании» (через сессию, без редиректа на login)
    export_url = (f"{base}/campaigns/show/main/?limit_date_begin={date_str}"
                  "&limit_date_end=&name=&campaign_id=&mediaplan_id=&agency_id=&advertiser_id="
                  "&manager_id=&organization_id=4&with%5B0%5D=formats&with%5B1%5D=category&export=xls")

    r = s.get(export_url, timeout=60, allow_redirects=False)
    loc = r.headers.get("Location", "")
    if r.status_code in (301, 302, 303, 307, 308) and "home/login" in (loc or ""):
        return msg_row("Cats session expired: redirected to login.", "is-danger")
    if r.status_code != 200:
        return msg_row(f"Cats export HTTP {r.status_code}", "is-danger")

    head = r.content[:800].decode("utf-8", errors="ignore").lower()
    if "<html" in head and "login" in head:
        return msg_row("Cats returned login page (auth required).", "is-danger")
    if "<workbook" not in head and "<?xml" not in head:
        snippet = head.replace("<", "&lt;").replace(">", "&gt;")
        return msg_row(f"Cats returned non-XML. Snippet: {snippet}", "is-danger")

    # 5) Парс SpreadsheetML -> (id, name)
    try:
        ns = {"ss": "urn:schemas-microsoft-com:office:spreadsheet"}
        root = ET.fromstring(r.content)
        ws = root.find(".//ss:Worksheet", ns)
        table = ws.find("ss:Table", ns) if ws is not None else None
        rows = table.findall("ss:Row", ns) if table is not None else []
        if not rows:
            return msg_row("Empty export (no rows).", "is-light")

        header = []
        for c in rows[0].findall("ss:Cell", ns):
            d = c.find("ss:Data", ns)
            header.append(d.text if d is not None else None)
        try:
            id_idx = header.index("ID")
            name_idx = header.index("Название")
        except Exception:
            id_idx, name_idx = 1, 2  # fallback

        pairs = []
        for r0 in rows[1:]:
            vals = []
            for c in r0.findall("ss:Cell", ns):
                d = c.find("ss:Data", ns)
                vals.append(d.text if d is not None else None)
            need = max(id_idx, name_idx) + 1
            if len(vals) < need:
                vals += [None] * (need - len(vals))
            cid_raw = vals[id_idx]
            name = vals[name_idx]
            n = (name or "").strip().lower()
            if "foxible" in n or "test" in n or "тест" in n:
                continue

            try:
                cid = int(str(cid_raw).strip())
            except Exception:
                cid = None
            if cid:
                pairs.append((cid, name))
    except Exception as e:
        return msg_row(f"Parse error: {e}", "is-danger")

    if not pairs:
        return msg_row("No campaigns in export.", "is-light")

    # 6) Добавляем только новые
    existing = set(int(getattr(c, "id")) for c in _ensure_list())
    new_ids = []
    for cid, name in pairs:
        n = (name or "").strip().lower()
        if "foxible" in n or "test" in n or "тест" in n:
            continue

        if cid in existing or cid in new_ids:
            continue
        try:
            try:
                from app.services import crud
                if hasattr(crud, "add"):
                    crud.add(id=cid, name=name)
                elif hasattr(crud, "add_campaign"):
                    crud.add_campaign(id=cid, name=name)
                else:
                    raise RuntimeError("crud.add not found")
            except Exception:
                dbp = os.path.join(os.getcwd(), "campaign_hub.db")
                con = sqlite3.connect(dbp)
                cur = con.cursor()
                cur.execute("CREATE TABLE IF NOT EXISTS campaigns (id INTEGER PRIMARY KEY, name TEXT)")
                cur.execute("INSERT OR IGNORE INTO campaigns (id, name) VALUES (?,?)", (cid, name))
                con.commit(); con.close()
            new_ids.append(cid)
        except Exception:
            print("Import row failed:\n", traceback.format_exc())

    if not new_ids:
        return msg_row("No new campaigns (nothing to add).", "is-light")

    # 7) Рендерим только новые строки
    latest = _ensure_list()
    by_id = {int(getattr(x, "id")): x for x in latest}
    html_parts = []
    for cid in new_ids:
        c = by_id.get(cid)
        if not c:
            continue
        _apply_totals(c)
        row_resp = _render_row_html(c)
        html_parts.append(row_resp.body.decode("utf-8", errors="ignore"))

    return HTMLResponse("".join(html_parts))



