{% extends "layout.html" %}
{% block content %}
<!-- cmpx-patch: details-slider-v6 -->

<style>
  :root{
    --nav-min: 180px;
    --navW: max(10vw, var(--nav-min));
    --topbar-h: 72px;      /* высота верхней чёрной шапки */
    --name-ch: 44ch;
    --hscroll-h: 0px;      /* реальную высоту блока с ползунком выставляем из JS */
  }

  html, body { overflow-x: hidden; }

/* ===== ползунок, пришитый к низу окна ===== */
  .cmpx-hscrollbar{
    position: fixed;
    left: var(--navW);                     /* начинается справа от левого меню */
    width: calc(90vw - var(--navW));       /* та же ширина, что и у .cmpx-main */
    bottom: 0;
    z-index: 30;
    background:#fff;
    padding:.25rem 5px;
    box-shadow:0 -1px 0 rgba(0,0,0,.06);
  }
  .cmpx-hscrollbar input[type="range"]{
    width:100%;
    cursor:pointer;
  }

  /* колонка Name (2-я) — фиксированная слева при горизонтальном скролле */
  #campaigns-table th:nth-child(2),
  #campaigns-table td:nth-child(2){
    position:sticky;
    left:0;
    z-index:5;
    background:#fff;
    box-shadow:1px 0 0 rgba(0,0,0,.06);
  }

  /* === prettier daily cells === */
  .dcell{
    cursor:pointer;
    display:inline-block;
    padding:.2rem .5rem;
    border-radius:.5rem;
    font-size:0.95rem;
    line-height:1.1;
    border:1px solid rgba(0,0,0,.06);
    background:rgba(0,0,0,.02);
    transition:transform .06s ease, background .06s ease, box-shadow .06s ease;
  }
  .dcell:hover{ transform:translateY(-1px); box-shadow:0 1px 3px rgba(0,0,0,.06); }
  .dcell:focus, .dcell:focus-visible{ outline:none; box-shadow:0 0 0 2px rgba(0,204,204,.25); }
  .dcell.is-overridden{
    color:#00cccc;
    border-color:rgba(0,204,204,.35);
    background:rgba(0,204,204,.06);
    font-weight:600;
  }

  .dcell.is-static{
    cursor:default;
    background:transparent;
    border-color:transparent;
    padding:0;
  }

  .dcell-editor input.input.is-small{
    width:10ch;
    text-align:right;
    font-size:0.95rem;
    padding:.3rem .5rem;
    border-radius:.5rem;
  }

  /* Левое меню — фиксированное, с отступом под шапку */
  .cmpx-nav{
    position: fixed; left:0; top:0; bottom:0;
    width: var(--navW);
    background:#303030; color:#fff;
    padding: calc(var(--topbar-h) + 8px) .5rem .75rem;
    z-index: 20;
  }
  .cmpx-nav h3{
    color:#fff; font-size:.85rem; text-transform:uppercase;
    opacity:.8; margin:.25rem .75rem;
  }
  .cmpx-nav a{
    color:#fff; display:block; padding:.5rem .75rem;
    border-radius:4px; text-decoration:none;
    font-weight:500; margin-bottom:.25rem;
  }
  .cmpx-nav a.is-active{
    color:#00cccc;
    background:rgba(255,255,255,.08);
  }

  /* Правая колонка */
.cmpx-main{
  margin-left: var(--navW);
  width: calc(90vw - var(--navW));
  /* сверху и по бокам оставляем как было,
     снизу добавляем место под ползунок */
  padding: 5px 5px calc(5px + var(--hscroll-h));
  box-sizing: border-box;
  overflow-x: hidden;
}

  .cmpx-main .section,
  .cmpx-main .container{
    max-width: none !important;
    width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box;
  }

  /* Тулбар */
  #toolbar{ max-width:100%; overflow:visible; box-sizing:border-box; }
  #toolbar .field.is-grouped{ flex-wrap: wrap; gap: .5rem .5rem; }
  #toolbar .control.is-expanded{ flex: 1 1 260px; min-width: 260px; }
  #toolbar .control{ flex: 0 0 auto; }

  /* Таблица может скроллиться по X, шапка липкая */
  #campaigns-table{
    overflow-x:auto;
    overflow-y:visible;
    position:relative;
    -webkit-overflow-scrolling:touch;
  }
  #campaigns-table > table{
    width:max-content;
    min-width:1200px;
  }
  #campaigns-table th,
  #campaigns-table td{
    white-space:nowrap;
  }
  #campaigns-table td:nth-child(2){ white-space:normal; }

  #campaigns-table thead th{
  position: sticky;
  top: 0;          /* или вообще убрать sticky, если не нужна липкая шапка */
  z-index: 4;
  background:#fff;
  box-shadow:0 1px 0 rgba(0,0,0,.06);
}

  #campaigns-table td:nth-child(2) .name-wrap{
    display:inline-block;
    max-width: var(--name-ch);
    white-space:normal;
    overflow-wrap:anywhere;
    word-break:break-word;
    hyphens:auto;
    line-height:1.2;
  }

  /* компактные размеры контролов */
  #toolbar .field.is-grouped .control{ margin-right:.5rem; }
  #toolbar .field.is-grouped .control:last-child{ margin-right:0; }
  #toolbar .input.is-small,
  #toolbar .select.is-small select,
  #toolbar .button.is-small{ height:2.25em; }
  #toolbar .mb-2{ margin-bottom:.5rem; }

  /* Details: отдельный горизонтальный скролл внутри раскрытой строки (для последних колонок) */
  #campaigns-table td[id^="details-"] .cmpx-details-xscroll{
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    max-width: 100%;
    -webkit-overflow-scrolling: touch;
  }
  #campaigns-table td[id^="details-"] .cmpx-details-xscroll > table{
    width: max-content !important;
    display: inline-table;
    max-width: none !important;
  }
  #campaigns-table td[id^="details-"] .cmpx-details-xscroll th,
  #campaigns-table td[id^="details-"] .cmpx-details-xscroll td{
    white-space: nowrap;
  }

</style>

<div class="cmpx-layout">
  <!-- Left menu -->
  <aside class="cmpx-nav">
    <h3>Menu</h3>
    <a href="/campaigns"
       class="{% if request.url.path == '/campaigns' %}is-active{% endif %}">
      Campaigns
    </a>
    <a href="/campaigns/groups"
       class="{% if request.url.path.startswith('/campaigns/groups') %}is-active{% endif %}">
      Groups
    </a>
    <a href="/campaigns/creatives"
       class="{% if request.url.path.startswith('/campaigns/creatives') %}is-active{% endif %}">
      Creatives
    </a>
        <a href="/campaigns/margin"
       class="{% if request.url.path.startswith('/campaigns/margin') %}is-active{% endif %}">
      Маржинальность
    </a>
  </aside>

  <!-- Main content -->
  <main class="cmpx-main">

    <!-- Мини-панель для поиска, сортировки, добавления -->
    <div class="box p-3" id="toolbar">
      <!-- Форма фильтров -->
      <form id="filters"
            class="mb-2"
            hx-get="/campaigns"
            hx-target="#campaigns-table"
            hx-select="#campaigns-table"
            hx-swap="outerHTML"
            hx-push-url="true">
        <div class="field is-grouped is-grouped-multiline is-align-items-center">
          <div class="control is-expanded" style="min-width:16rem">
            <input class="input is-small"
                   type="text"
                   name="q"
                   value="{{ q or '' }}"
                   placeholder="Поиск: ID / название"
                   hx-trigger="keyup changed delay:300ms" />
          </div>

          <div class="control">
            <div class="select is-small">
              <select name="sort" hx-trigger="change">
                <option value="id"          {{ 'selected' if (sort or 'id')=='id' }}>ID</option>
                <option value="name"        {{ 'selected' if sort=='name' }}>Название</option>
                <option value="impressions" {{ 'selected' if sort=='impressions' }}>Показы</option>
                <option value="clicks"      {{ 'selected' if sort=='clicks' }}>Клики</option>
                <option value="uniques"     {{ 'selected' if sort=='uniques' }}>Охват</option>
                <option value="ctr_ext"     {{ 'selected' if sort=='ctr_ext' }}>CTR</option>
                <option value="freq"        {{ 'selected' if sort=='freq' }}>Частота</option>
              </select>
            </div>
          </div>

          <div class="control">
            <div class="select is-small">
              <select name="dir" hx-trigger="change">
                <option value="desc" {{ 'selected' if (dir or 'desc')=='desc' }}>По убыванию</option>
                <option value="asc"  {{ 'selected' if dir=='asc' }}>По возрастанию</option>
              </select>
            </div>
          </div>

          <div class="control">
            <button class="button is-small">Применить</button>
          </div>
        </div>
      </form>

      <!-- Форма добавления кампании + Cats + Update All -->
      <form action="/campaigns" method="post">
        <div class="field is-grouped is-grouped-multiline">
          <div class="control">
            <input class="input is-small"
                   type="number"
                   name="id"
                   id="campaign_id"
                   placeholder="Campaign ID"
                   required>
          </div>
          <div class="control is-expanded" style="min-width:16rem">
            <input class="input is-small"
                   type="text"
                   name="name"
                   placeholder="Campaign Name"
                   required>
          </div>
          <div class="control">
            <button class="button is-link is-small" type="submit">Add</button>
          </div>

          <div class="control">
            <button type="button"
                    class="button is-info is-small"
                    hx-post="/campaigns/import_cats"
                    hx-target="#campaigns-body"
                    hx-swap="beforeend">
              Import Cats
            </button>
          </div>

          <div class="control">
            <button type="button"
                    class="button is-success is-small"
                    hx-post="/campaigns/pull_all"
                    hx-target="#bulk-status"
                    hx-swap="innerHTML">
              Update All
            </button>
          </div>
          <div class="control">
            <span id="bulk-status" class="tag is-light">—</span>
          </div>
        </div>
      </form>
    </div>

    <!-- Липкий ползунок -->
    <div class="cmpx-hscrollbar">
      <input type="range"
             class="cmpx-hslider"
             data-target="#campaigns-table"
             min="0"
             value="0"
             step="1"
             max="500" />
    </div>

    <!-- Таблица кампаний -->
    <div id="campaigns-table">
      <table class="table is-striped is-fullwidth">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Период</th>
            <th>Показы</th>
            <th>Клики</th>
            <th>Расход</th>
            <th>Охват</th>
            <th>Конверсии</th>
            <th>CTR</th>
            <th>Частота</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="campaigns-body">
          {% for row in campaigns %}
          <tr id="row-{{ row.id }}">
            <td>{{ row.id }}</td>
            <td><span class="name-wrap" title="{{ row.name }}">{{ row.name }}</span></td>
            <td>
              {% if row.min_date and row.max_date %}
                {{ row.min_date }} — {{ row.max_date }}
              {% else %}
                —
              {% endif %}
            </td>
            <td><span id="imp-{{ row.id }}">{{ row.impressions or "–" }}</span></td>
            <td><span id="clk-{{ row.id }}">{{ row.clicks or "–" }}</span></td>
            <td>{{ row.spend or "–" }}</td>
            <td><span id="uniq-{{ row.id }}">{{ row.uniques or "–" }}</span></td>
            <td>{{ row.conversions or "–" }}</td>
            <td>
              <span id="ctr-{{ row.id }}">
                {{ "%.2f%%"|format(row.ctr_ext*100) if (row.ctr_ext is defined and row.ctr_ext is not none) else "–" }}
              </span>
            </td>
            <td>
              <span id="freq-{{ row.id }}">
                {{ "%.2f"|format(row.freq) if (row.freq is defined and row.freq is not none) else "–" }}
              </span>
            </td>
            <td class="is-narrow">
              <button type="button"
                      class="button is-info is-small"
                      hx-post="/campaigns/{{ row.id }}/pull"
                      hx-target="#camp-{{ row.id }}-status"
                      hx-swap="innerHTML">
                Update
              </button>

              <span id="camp-{{ row.id }}-status" class="tag is-light">—</span>

              <button type="button"
                      class="button is-warning is-small"
                      hx-post="/campaigns/{{ row.id }}/yandex_update"
                      hx-target="#camp-{{ row.id }}-status"
                      hx-swap="innerHTML">
                Yandex
              </button>

              <button type="button"
                      class="button is-small is-light"
                      hx-get="/campaigns/{{ row.id }}/daily5"
                      hx-target="#details-{{ row.id }}"
                      hx-swap="outerHTML">
                <span hx-indicator="#details-{{ row.id }}">Details</span>
              </button>

              <button type="button"
                      class="button is-small is-light is-danger is-outlined"
                      hx-get="/campaigns/{{ row.id }}/daily_empty"
                      hx-target="#details-{{ row.id }}"
                      hx-swap="outerHTML">
                Hide
              </button>

              <button type="button"
                      class="button is-small is-primary is-light"
                      hx-get="/campaigns/{{ row.id }}/edit"
                      hx-target="#row-{{ row.id }}"
                      hx-swap="outerHTML">
                Edit
              </button>

              <button type="button"
                      class="button is-small is-danger is-light"
                      hx-post="/campaigns/{{ row.id }}/delete"
                      hx-target="#row-{{ row.id }}"
                      hx-swap="outerHTML">
                Delete
              </button>
            </td>
          </tr>
          <tr><td colspan="11" id="details-{{ row.id }}"></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      // cmpx: details-slider-v5
      // Один ползунок управляет горизонтальным скроллом:
      //  - основной таблицы (#campaigns-table)
      //  - и (если есть) внутренних скролл-контейнеров в details (td#details-...),
      //    чтобы можно было докрутить до самых последних колонок.
      (function(){
        function clamp(n, lo, hi){
          n = Number.isFinite(n) ? n : 0;
          return Math.max(lo, Math.min(hi, n));
        }

        function maxScrollX(el){
          try{
            return Math.max(0, (el.scrollWidth || 0) - (el.clientWidth || 0));
          }catch(e){
            return 0;
          }
        }

        function ensureDetailsXScroll(td){
          // td — это <td id="details-...">, который приходит из /daily5 или /daily_empty
          if (!td || !td.id || !td.id.startsWith('details-')) return;

          // Если уже сделали обёртку — ничего не делаем
          if (td.querySelector(':scope > .cmpx-details-xscroll')) return;

          // 1) Если details уже обёрнут Bulma-обёрткой (редко) — используем её
          const directTC = td.querySelector(':scope > .table-container');
          if (directTC){
            directTC.classList.add('cmpx-details-xscroll');
            return;
          }

          // 2) Обычно daily5 возвращает: <td ...><table ...>...</table></td>
          const directTable = td.querySelector(':scope > table');
          if (!directTable) return;

          const wrap = document.createElement('div');
          wrap.className = 'cmpx-details-xscroll';
          wrap.appendChild(directTable);
          td.insertBefore(wrap, td.firstChild);
        }

        function wrapAllDetails(root){
          const scope = root || document;
          scope.querySelectorAll('td[id^="details-"]').forEach(ensureDetailsXScroll);
        }

        function collectScrollTargets(slider){
          const targets = [];

          // main container
          const mainSel = slider.dataset.target;
          if (mainSel){
            const main = document.querySelector(mainSel);
            if (main) targets.push(main);
          }

          // details containers
          document
            .querySelectorAll('#campaigns-table td[id^="details-"] .cmpx-details-xscroll')
            .forEach(function(el){ targets.push(el); });

          // на всякий (если вдруг где-то есть table-container)
          document
            .querySelectorAll('#campaigns-table td[id^="details-"] > .table-container')
            .forEach(function(el){ targets.push(el); });

          return targets;
        }

        function recalcSlider(slider){
          wrapAllDetails(document);

          const targets = collectScrollTargets(slider);
          let trueMax = 0;
          let cur = 0;

          targets.forEach(function(el){
            const m = maxScrollX(el);
            if (m > trueMax) trueMax = m;
            if ((el.scrollLeft || 0) > cur) cur = (el.scrollLeft || 0);
          });

          // step=1 чтобы гарантированно доезжать до точного trueMax (иначе "не хватает пару пикселей")
          slider.step = '1';
          slider.max = String(trueMax);
          slider.disabled = trueMax <= 0;
          slider.value = String(clamp(cur, 0, trueMax));
        }

        function scrollAll(slider, value){
          const targets = collectScrollTargets(slider);
          targets.forEach(function(el){
            const m = maxScrollX(el);
            el.scrollLeft = clamp(value, 0, m);
          });
        }

        function attachSlider(slider){
          recalcSlider(slider);

          slider.addEventListener('input', function(){
            scrollAll(slider, parseFloat(slider.value) || 0);
          });

          // Если пользователь скроллит руками/тачпадом — подтягиваем ползунок
          const syncFromScroll = function(){
            // берём максимальный scrollLeft среди целей, чтобы ползунок отражал "самый правый" сдвиг
            const targets = collectScrollTargets(slider);
            let cur = 0;
            targets.forEach(function(el){
              if ((el.scrollLeft || 0) > cur) cur = (el.scrollLeft || 0);
            });
            slider.value = String(clamp(cur, 0, parseFloat(slider.max) || 0));
          };

          // подписываемся на scroll событий у главного контейнера
          const mainSel = slider.dataset.target;
          if (mainSel){
            const main = document.querySelector(mainSel);
            if (main){
              main.addEventListener('scroll', syncFromScroll, {passive:true});
            }
          }

          // и у details-контейнеров (если появятся — мы добавим слушатели после htmx swap)
          slider._cmpx_syncFromScroll = syncFromScroll;

          window.addEventListener('resize', function(){
            recalcSlider(slider);
          });
        }

        function updateHScrollHeight(){
          const sb = document.querySelector('.cmpx-hscrollbar');
          if (!sb) return;
          const h = sb.offsetHeight || 0;
          document.documentElement.style.setProperty('--hscroll-h', h + 'px');
        }

        function bindDetailsScrollListeners(){
          const slider = document.querySelector('.cmpx-hslider');
          if (!slider || !slider._cmpx_syncFromScroll) return;

          document
            .querySelectorAll('#campaigns-table td[id^="details-"] > .cmpx-details-xscroll, #campaigns-table td[id^="details-"] > .table-container')
            .forEach(function(el){
              if (el._cmpx_bound) return;
              el._cmpx_bound = true;
              el.addEventListener('scroll', slider._cmpx_syncFromScroll, {passive:true});
            });
        }

        function initAll(){
          document.querySelectorAll('.cmpx-hslider').forEach(attachSlider);
          updateHScrollHeight();
          wrapAllDetails(document);
          bindDetailsScrollListeners();
          document.querySelectorAll('.cmpx-hslider').forEach(recalcSlider);
        }

        document.addEventListener('DOMContentLoaded', initAll);
        window.addEventListener('resize', updateHScrollHeight);

        if (window.htmx){
          // На любой swap — оборачиваем details, биндируем scroll и пересчитываем max
          document.body.addEventListener('htmx:afterSwap', function(){
            requestAnimationFrame(function(){
              wrapAllDetails(document);
              bindDetailsScrollListeners();
              document.querySelectorAll('.cmpx-hslider').forEach(recalcSlider);
              updateHScrollHeight();
            });
          });

          // afterSettle — на случай, если размеры меняются после вставки
          document.body.addEventListener('htmx:afterSettle', function(){
            const slider = document.querySelector('.cmpx-hslider');
            if (!slider) return;
            requestAnimationFrame(function(){
              wrapAllDetails(document);
              bindDetailsScrollListeners();
              recalcSlider(slider);
            });
          });
        }
      })();
    </script>

  </main>
</div>

{% endblock %}
