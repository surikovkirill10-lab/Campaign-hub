{# Контекст: request, b, camp, shots (list[dict]) #}
{% set has = shots and (shots|length) > 0 %}
{% if has %}
  {% set main = (shots | selectattr('is_primary', 'equalto', 1) | list | first) or shots[0] %}
  <div class="shot-main">
    <figure class="image">
      <img src="{{ url_for('static', path=main['file_path']) }}" alt="Основной скриншот">
    </figure>
  </div>

  {% set others = [] %}
  {% for s in shots if s['id'] != main['id'] %}
    {% if others.append(s) %}{% endif %}
  {% endfor %}
  {% set thumbs = others[:3] %}

  {% if thumbs %}
    <div class="shot-thumbs">
      {% for s in thumbs %}
        <div class="shot-thumb {% if s['is_primary'] %}is-primary{% endif %}">
          <img src="{{ url_for('static', path=s['file_path']) }}" alt="Скриншот {{ loop.index }}">
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="shot-actions">
    <form hx-post="/bookings/{{ b.id }}/screenshots/{{ main['id'] }}/delete"
          hx-target="#shots" hx-swap="outerHTML">
      <button class="button is-small is-light" type="submit">Удалить основной</button>
    </form>

    {% for s in shots if s['id'] != main['id'] %}
      <form hx-post="/bookings/{{ b.id }}/screenshots/{{ s['id'] }}/make_primary"
            hx-target="#shots" hx-swap="outerHTML" class="is-inline">
        <button class="button is-small" type="submit">Сделать основным #{{ loop.index }}</button>
      </form>
    {% endfor %}
  </div>
{% else %}
  <p class="has-text-grey">Пока нет скриншотов.</p>
{% endif %}

<form class="mt-3"
      hx-post="/bookings/{{ b.id }}/screenshots/upload"
      hx-encoding="multipart/form-data"
      hx-target="#shots" hx-swap="outerHTML">
  <div class="file has-name is-small">
    <label class="file-label">
      <input class="file-input" type="file" name="files" accept="image/*" multiple>
      <span class="file-cta">
        <span class="file-label">Выбрать файлы…</span>
      </span>
    </label>
  </div>
  <div class="shot-actions" style="margin-top:.5rem">
    <button class="button is-info is-light is-small" type="submit">Загрузить</button>
    <span class="upload-note">до 4 превью (показывается 1 основной + 1–3 миниатюры)</span>
  </div>
</form>
