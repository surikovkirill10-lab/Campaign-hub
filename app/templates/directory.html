{% extends "layout.html" %}
{% block content %}

<style>
  :root{
    --nav-min: 180px;
    --navW: max(10vw, var(--nav-min));
    --topbar-h: 72px;
    --name-ch: 44ch;  /* целевая длина строки для названий */
  }
  html, body { overflow-x: hidden; }

  .cmpx-nav{
    position: fixed;
    left:0; top:0; bottom:0;
    width:var(--navW);
    background:#303030; color:#fff;
    padding: calc(var(--topbar-h) + 8px) .5rem .75rem;
    z-index: 20;
  }
  .cmpx-nav h3{
    color:#fff; font-size:.85rem; text-transform:uppercase;
    opacity:.8; margin:.25rem .75rem;
  }
  .cmpx-nav a{
    color:#fff; display:block; padding:.5rem .75rem;
    border-radius:4px; text-decoration:none;
    font-weight:500; margin-bottom:.25rem;
  }
  .cmpx-nav a.is-active{
    color:#00cccc;
    background:rgba(255,255,255,.08);
  }

  .nav-directory-label{
    font-size:.75rem;
    text-transform:uppercase;
    opacity:.6;
    margin:.75rem .75rem .25rem;
  }
  .nav-directory a{
    font-size:.9rem;
    padding-left:1.4rem;
  }

  .cmpx-main{
    margin-left:var(--navW);
    width: calc(90vw - var(--navW));
    padding: 5px;
    box-sizing:border-box;
    overflow-x:hidden;
  }

  /* ===== тулбар фильтров (как в campaigns) ===== */
  #toolbar{
    max-width:100%;
    overflow:visible;
    box-sizing:border-box;
  }
  #toolbar .field.is-grouped{
    flex-wrap: wrap;
    gap: .5rem .5rem;
  }
  #toolbar .control.is-expanded{
    flex: 1 1 260px;
    min-width: 260px;
  }
  #toolbar .control{
    flex: 0 0 auto;
  }
  #toolbar .field.is-grouped .control{ margin-right:.5rem; }
  #toolbar .field.is-grouped .control:last-child{ margin-right:0; }
  #toolbar .input.is-small,
  #toolbar .select.is-small select,
  #toolbar .button.is-small{
    height:2.25em;
  }
  #toolbar .mb-2{ margin-bottom:.5rem; }

  /* ===== горизонтальный скролл + ползунок ===== */
  .cmpx-hscrollbar{
    margin:.25rem 0 .5rem;
  }
  .cmpx-hscrollbar input[type="range"]{
    width:100%;
  }
  .cmpx-table-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    position:relative;
  }
  .cmpx-table-wrap table{
    width:max-content;
    min-width: 100%;
  }

  /* чтобы таблицы не разъезжались */
  .cmpx-table-wrap th,
  .cmpx-table-wrap td{
    white-space:nowrap;
  }

  /* Название кампании / группы — переносимая, но sticky колонка (3-я) */
  .dir-camp-table th:nth-child(3),
  .dir-camp-table td:nth-child(3),
  .dir-group-table th:nth-child(3),
  .dir-group-table td:nth-child(3){
    position:sticky;
    left:0;
    z-index:3;
    background:#fff;
  }

  .dir-camp-table td:nth-child(3),
  .dir-group-table td:nth-child(3){
    white-space:normal;
    max-width: var(--name-ch);
    overflow-wrap:anywhere;
    word-break:break-word;
  }
</style>

<div class="cmpx-layout">
  <aside class="cmpx-nav">
    <h3>Menu</h3>
    <a href="/campaigns">Campaigns</a>
    <a href="/bookings">Брони</a>

    <div class="nav-directory">
      <div class="nav-directory-label">Directory</div>
      <a href="/directory" class="is-active">
        Почта / Verifier
      </a>
      <a href="/directory/mediaplanner">
        Media planner
      </a>
    </div>
  </aside>

  <main class="cmpx-main">

    <div class="block">
      <h2 class="subtitle">Directory</h2>
      <p>Мэппинг кампаний/групп на правила почты (Yandex + Verifier).</p>
    </div>

    <div class="block">
<button type="button"
        class="button is-warning is-small"
        hx-post="/directory/yandex_update"
        hx-swap="innerHTML">
  Yandex
</button>

      <button type="button"
              class="button is-primary is-small"
              onclick="importSelectedVerifiers()">
        Import verifiers (selected campaigns & groups)
      </button>
    </div>

    <!-- === ФИЛЬТРЫ / ПОИСК как в campaigns === -->
    <div class="box p-3" id="toolbar">
      <form id="directory-filters"
            class="mb-2"
            hx-get="/directory"
            hx-target="#directory-tables"
            hx-select="#directory-tables"
            hx-swap="outerHTML"
            hx-push-url="true">
        <div class="field is-grouped is-grouped-multiline is-align-items-center">
          <div class="control is-expanded" style="min-width:16rem">
            <input class="input is-small"
                   type="text"
                   name="q"
                   value="{{ q or '' }}"
                   placeholder="Поиск: ID / название кампании или группы"
                   hx-trigger="keyup changed delay:300ms" />
          </div>

          <div class="control">
            <div class="select is-small">
              <select name="sort" hx-trigger="change">
                <option value="id"   {{ 'selected' if (sort or 'id')=='id' }}>ID</option>
                <option value="name" {{ 'selected' if sort=='name' }}>Название</option>
              </select>
            </div>
          </div>

          <div class="control">
            <div class="select is-small">
              <select name="dir" hx-trigger="change">
                <option value="desc" {{ 'selected' if (dir or 'desc')=='desc' }}>По убыванию</option>
                <option value="asc"  {{ 'selected' if dir=='asc' }}>По возрастанию</option>
              </select>
            </div>
          </div>

          <div class="control">
            <button class="button is-small">Применить</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Всё, что дальше (две таблицы), будет перерисовываться по фильтрам -->
    <div id="directory-tables">

      <!-- CAMPAIGNS -->
      <h4 class="title is-6">Campaign bindings</h4>

      <!-- ползунок для горизонтального скролла -->
      <div class="cmpx-hscrollbar">
        <input type="range"
               class="cmpx-hslider"
               data-target="#dir-camp-table-wrap"
               min="0"
               value="0"
               step="1" />
      </div>

      <div id="dir-camp-table-wrap" class="cmpx-table-wrap">
        <table class="table is-striped is-fullwidth dir-camp-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="sel_all" onclick="toggleAll(this)"></th>
              <th>ID</th>
              <th>Name</th>
              <th>Yandex name</th>
              <th>Provider</th>
              <th>Subject pattern</th>
              <th>Subject match</th>
              <th>Filename pattern</th>
              <th>Filename match</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for camp in campaigns %}
            {% set v = verifier_map.get(camp.id) or {} %}
            <tr>
              <td><input type="checkbox" class="sel_row" value="{{ camp.id }}"></td>
              <td>{{ camp.id }}</td>
              <td>{{ camp.name }}</td>
              <td>
                <input class="input is-small"
                       type="text"
                       name="yandex_name_{{ camp.id }}"
                       value="{{ yandex_map.get(camp.id) or '' }}"
                       placeholder="например: Pesto2flight_Inlab">
              </td>
              <td>
                <div class="select is-small">
                  <select name="ver_provider_{{ camp.id }}">
                    {% for opt in ['weborama','adserving','adriver','targetads'] %}
                      <option value="{{ opt }}" {% if v.get('provider')==opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <input class="input is-small"
                       type="text"
                       name="ver_name_{{ camp.id }}"
                       value="{{ v.get('verifier_name') or '' }}"
                       placeholder="часть темы письма; напр. innlab_parodontax_sep-nov_2025_ver_">
              </td>
              <td>
                <div class="select is-small">
                  <select name="ver_subj_mode_{{ camp.id }}">
                    {% for m in ['contains','exact','startswith','endswith','regex'] %}
                      <option value="{{ m }}" {% if (v.get('subject_mode') or 'contains')==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <input class="input is-small"
                       type="text"
                       name="ver_fname_pat_{{ camp.id }}"
                       value="{{ v.get('filename_pattern') or '' }}"
                       placeholder="часть имени файла; напр. fraud_report_">
              </td>
              <td>
                <div class="select is-small">
                  <select name="ver_fname_mode_{{ camp.id }}">
                    {% for m in ['contains','exact','startswith','endswith','regex'] %}
                      <option value="{{ m }}" {% if (v.get('filename_mode') or 'contains')==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-link is-light" onclick="saveVerifier({{ camp.id }})">Save</button>
                  <button class="button is-primary is-light" onclick="saveYandexName({{ camp.id }})">Save Yandex</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- GROUPS -->
      <h4 class="title is-6 mt-5">Verifier group bindings</h4>

      <!-- ползунок для горизонтального скролла -->
      <div class="cmpx-hscrollbar">
        <input type="range"
               class="cmpx-hslider"
               data-target="#dir-group-table-wrap"
               min="0"
               value="0"
               step="1" />
      </div>

      <div id="dir-group-table-wrap" class="cmpx-table-wrap">
        <table class="table is-striped is-fullwidth dir-group-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="sel_groups_all" onclick="toggleAllGroups(this)"></th>
              <th>Group ID</th>
              <th>Group name</th>
              <th>Provider</th>
              <th>Subject pattern</th>
              <th>Subject match</th>
              <th>Filename pattern</th>
              <th>Filename match</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for g in groups %}
            {% set b = group_bindings.get(g.id) or {} %}
            <tr>
              <td><input type="checkbox" class="sel_group_row" value="{{ g.id }}"></td>
              <td>{{ g.id }}</td>
              <td>{{ g.name }}</td>
              <td>
                <div class="select is-small">
                  <select name="grp_provider_{{ g.id }}">
                    {% for opt in ['weborama','adserving','adriver','targetads'] %}
                      <option value="{{ opt }}" {% if b.get('provider')==opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <input class="input is-small"
                       type="text"
                       name="grp_subj_{{ g.id }}"
                       value="{{ b.get('subject_pattern') or '' }}"
                       placeholder="часть темы/шаблон; напр. Richard_OLV">
              </td>
              <td>
                <div class="select is-small">
                  <select name="grp_subj_mode_{{ g.id }}">
                    {% for m in ['contains','exact','startswith','endswith','regex'] %}
                      <option value="{{ m }}" {% if (b.get('subject_mode') or 'contains')==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <input class="input is-small"
                       type="text"
                       name="grp_fname_pat_{{ g.id }}"
                       value="{{ b.get('filename_pattern') or '' }}"
                       placeholder="часть имени файла; напр. fraud_report_">
              </td>
              <td>
                <div class="select is-small">
                  <select name="grp_fname_mode_{{ g.id }}">
                    {% for m in ['contains','exact','startswith','endswith','regex'] %}
                      <option value="{{ m }}" {% if (b.get('filename_mode') or 'contains')==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              <td>
                <button class="button is-link is-small is-light" onclick="saveVerifierGroup({{ g.id }})">Save</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div> <!-- /#directory-tables -->

    <script>
    function saveYandexName(campaignId) {
      const field = document.querySelector('input[name="yandex_name_' + campaignId + '"]');
      fetch('/directory/yandex/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: campaignId, yandex_name: field.value })
      })
      .then(resp => resp.ok ? resp.json() : resp.text().then(t => { throw new Error(t); }))
      .then(_ => alert('Yandex name сохранён'))
      .catch(err => alert('Ошибка: ' + err.message));
    }

    function saveVerifier(campaignId) {
      const payload = {
        id: campaignId,
        provider: document.querySelector('select[name="ver_provider_' + campaignId + '"]').value,
        verifier_name: document.querySelector('input[name="ver_name_' + campaignId + '"]').value,
        subject_mode: document.querySelector('select[name="ver_subj_mode_' + campaignId + '"]').value,
        filename_pattern: document.querySelector('input[name="ver_fname_pat_' + campaignId + '"]').value,
        filename_mode: document.querySelector('select[name="ver_fname_mode_' + campaignId + '"]').value
      };
      fetch('/directory/verifier/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(resp => resp.ok ? resp.json() : resp.text().then(t => { throw new Error(t); }))
      .then(_ => alert('Verifier (campaign) сохранён'))
      .catch(err => alert('Ошибка: ' + err.message));
    }

    function saveVerifierGroup(groupId) {
      const payload = {
        group_id: groupId,
        provider: document.querySelector('select[name="grp_provider_' + groupId + '"]').value,
        subject_pattern: document.querySelector('input[name="grp_subj_' + groupId + '"]').value,
        subject_mode: document.querySelector('select[name="grp_subj_mode_' + groupId + '"]').value,
        filename_pattern: document.querySelector('input[name="grp_fname_pat_' + groupId + '"]').value,
        filename_mode: document.querySelector('select[name="grp_fname_mode_' + groupId + '"]').value
      };
      fetch('/directory/verifier/group/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(resp => resp.ok ? resp.json() : resp.text().then(t => { throw new Error(t); }))
      .then(_ => alert('Verifier (group) сохранён'))
      .catch(err => alert('Ошибка: ' + err.message));
    }

    function toggleAll(master) {
      document.querySelectorAll('.sel_row').forEach(ch => ch.checked = master.checked);
    }
    function toggleAllGroups(master) {
      document.querySelectorAll('.sel_group_row').forEach(ch => ch.checked = master.checked);
    }

    function importSelectedVerifiers() {
      const ids = Array.from(document.querySelectorAll('.sel_row:checked')).map(ch => parseInt(ch.value, 10));
      const group_ids = Array.from(document.querySelectorAll('.sel_group_row:checked')).map(ch => parseInt(ch.value, 10));
      fetch('/directory/verifier/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids, group_ids: group_ids })
      })
      .then(resp => resp.text())
      .then(html => {
        const div = document.createElement('div');
        div.innerHTML = html;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 10000);
      })
      .catch(err => alert('Ошибка: ' + err.message));
    }

    /* ===== общий JS для ползунков горизонтального скролла ===== */
    (function(){
      function recalcSlider(slider){
        const targetSelector = slider.dataset.target;
        if (!targetSelector) return;
        const target = document.querySelector(targetSelector);
        if (!target) return;
        const max = Math.max(0, target.scrollWidth - target.clientWidth);
        slider.max = max;
        slider.disabled = max <= 0;
        if (+slider.value > max) slider.value = max;
      }

      function attachSlider(slider){
        recalcSlider(slider);
        slider.addEventListener('input', function(){
          const targetSelector = slider.dataset.target;
          const target = document.querySelector(targetSelector);
          if (!target) return;
          target.scrollLeft = slider.value;
        });
        window.addEventListener('resize', function(){ recalcSlider(slider); });
      }

      function initAll(){
        document.querySelectorAll('.cmpx-hslider').forEach(attachSlider);
      }

      document.addEventListener('DOMContentLoaded', initAll);

      if (window.htmx){
        document.body.addEventListener('htmx:afterSwap', function(evt){
          // если перерисовали таблицы directory — просто пересчитаем максимумы
          if (evt.target && evt.target.id === 'directory-tables'){
            document.querySelectorAll('.cmpx-hslider').forEach(recalcSlider);
          }
        });
      }
    })();
    </script>
  </main>
</div>

{% endblock %}
